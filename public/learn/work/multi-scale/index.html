<!DOCTYPE html>
<html>
<head>
<!DOCTYPE html>
<html lang="en-us">



<link rel="stylesheet" href="/css/fonts.css">
<link rel="stylesheet" href="/css/main-site.css">
<link rel="stylesheet" href="/css/fa5-all.css">
<style type="text/css">
    body {
	background-color: #ffffff;
	color: #404040
}

/* Links */

a {
  color: #CA225E;
}

a:hover {
  color: #cc3168;
}

/* Landing page content bands */

#homeContent .band.first {
  background-color: #ffffff
}

#homeContent .band.second {
  background-color: #fcfcfc
}

#homeContent .band.third {
  background-color: #ffffff
}

/* Top navigation bar menu */

#rStudioHeader {
  background-color: #ffffff;
  color: black;
}

#rStudioHeader .productName {
  color: #CA225E
}

#rStudioHeader .productName:hover {
  color: #00000075
}

#rStudioHeader #menu .menuItem.a {
  background-color: #75aadb;
  color: black;
}

#rStudioHeader #menu .menuItem:hover {
  background-color: white;
  color: #CA225E;
}

#rStudioHeader #menu .menuItem.current {
  background-color: #fcfcfc;
  color: #CA225E;
  text-decoration: none;
}

/* Footer */

#rStudioFooter.band {
  background-color: #CA225E40;
}

#rStudioFooter .bandContent #copyright {
  color: #CA225E;
}

/* Tables */

table tbody tr:nth-child(even){
  background-color: #fcfcfc;
}

table tbody tr:nth-child(odd){
  background-color: #1a162d10;
}

.latest {
  border-top: .5em solid <no value>;
}
</style>

  <link rel="stylesheet" href="/css/tm.css">




<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="apple-mobile-web-app-capable" content="yes" />

<meta name="og:image" content="https://www.tidymodels.org/images/feature_summary_large_image.jpg" >

  <meta property="twitter:card" content="summary_large_image">

<meta name="twitter:image" content="https://www.tidymodels.org/images/feature_summary_large_image.jpg" ><meta name="generator" content="Hugo 0.96.0" />

<meta property="og:type" content="website"><title>Learn - Multi-scale model assessment with spatialsample</title>
    <meta property="og:title" content="Learn - Multi-scale model assessment with spatialsample">
    
    
    
    
    <meta property="description" content="Assess how accurate a model is when aggregating predictions to different spatial scales.
">
    <meta property="og:description" content="Assess how accurate a model is when aggregating predictions to different spatial scales.
">



<link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png" />
<link rel="manifest" href="/images/favicons/site.webmanifest" />
<link rel="mask-icon" href="/images/favicons/safari-pinned-tab.svg" />
<link rel="shortcut icon" href="/images/favicons/favicon.ico" />
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" href="/images/favicons/browserconfig.xml" >



<script type="text/javascript" src="/js/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="/js/site.js"></script>


  <script type="text/javascript" src="/js/tm.js"></script>


<link rel="icon" href="/images/favicon.ico" />


<script defer data-domain="tidymodels.org,all.tidymodels.org" src="https://plausible.io/js/plausible.js"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>



  <body>
    <div id="appTidyverseSite" class="shrinkHeader alwaysShrinkHeader">
      <div id="main">
        
        <div id="rStudioHeader">
          <div class="band">
            <div class="innards bandContent">
              <div>
                <a class="productName" href="/">Tidymodels</a>
                
              </div>
              <div id="menu">
  <div id="menuToggler"></div>
  <div id="menuItems" class="">
    
    
      
      
      
    <a class="menuItem " href="/packages/">Packages</a>
    
      
      
      
    <a class="menuItem " href="/start/">Get Started</a>
    
      
      
      
    <a class="menuItem current" href="/learn/">Learn</a>
    
      
      
      
    <a class="menuItem " href="/help/">Help</a>
    
      
      
      
    <a class="menuItem " href="/contribute/">Contribute</a>
    
      
      
      
    <a class="menuItem " href="/find/"><i class="fas fa-search fa-lg"></i> </a>
    
      
      
      
    <a class="menuItem " href="https://github.com/tidymodels/"><i class="fab fa-github fa-lg"></i></a>
    
  </div>
</div>

            </div>
          </div>
        </div>
</head>
<body>


 




<div class="band padForHeader pushFooter">
  <div class="bandContent">
    <div class="full splitColumns withMobileMargins">
      <div class="column75">
        
        <div class="section">
          <div class="sectionTitle">
            <a href="/learn/">
              <i class="fas fa-chevron-left"></i>&nbsp;Back to Learn
            </a>
          </div>
        </div>

      <h1 class="article-title">Multi-scale model assessment with spatialsample</h1>

      
      <div class="article-header">
        </div>
        

      
      
      
      
        </p>
      
        
      <div class="learning-objective-container">
        <h2 class="learning-objective">Learning objective</h2>
        <p class="single-learning-objective-text">Assess how accurate a model is when aggregating predictions to different spatial scales.</p>
      </div>
      

      <div class="article-content">
      <h2 id="introduction">Introduction</h2>
<p>To use the code in this article, you will need to install the following packages: spatialsample and tidymodels.</p>
<p>Modeling spatially structured data is complicated. In addition to the usual difficulty of statistical modeling, models of spatially structured data may have spatial structure in their errors, with different regions being more or less well-described by a given model. This also means that it can be hard to tell how well your model performs when its predictions are aggregated to different scales, which is common when models fit to data from point measurements (for instance, the sale prices of individual homes) are used to try and estimate quantities over an entire area (the average value of all homes in a city or state). If model accuracy is only investigated at individual aggregation scales, such as when accuracy is only assessed for the original point measurements or across the entire study area as a whole, then local differences in accuracy might be &ldquo;smoothed out&rdquo; accidentally resulting in an inaccurate picture of model performance.</p>
<p>For this reason, researchers (most notably, <a href="https://www.nrs.fs.fed.us/pubs/jrnl/2010/nrs_2010_riemann_001.pdf">Riemann et al. (2010)</a>) have suggested assessing models at multiple scales of spatial aggregation to ensure cross-scale differences in model accuracy are identified and reported. This is not the same thing as <a href="https://www.tidymodels.org/start/tuning/">tuning a model</a>, where we&rsquo;re looking to select the best hyperparameters for our final model fit; instead, we want to assess how that final model performs when its predictions are aggregated to multiple scales. This post walks through how to do that using the <a href="https://spatialsample.tidymodels.org/">spatialsample</a> package.</p>
<h2 id="multi-scale-assessment">Multi-scale Assessment</h2>
<p>Because Riemann et al. were working with data from the US Forest Inventory and Analysis (FIA) program, we&rsquo;re going to do the same. However, because our main goal is to show how spatialsample can support this type of analysis, we won&rsquo;t spend a ton of time worrying about any of the quirks of FIA data or on feature engineering. Instead, we&rsquo;re going to use a simple linear model to see if we can predict how much aboveground biomass (&ldquo;AGB&rdquo;; all the non-root woody bits of trees) there is in a forest based on how many trees there are. We&rsquo;ll use all the FIA field data from New York State, USA.</p>
<p>Because we&rsquo;re mostly interested in assessing our models, let&rsquo;s not focus on how exactly to download and wrangle the FIA data. If you&rsquo;re curious, the code is in a hidden chunk here:</p>
<details>
<summary>Pre-processing code</summary>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#00f">library</span>(dplyr)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Download the FIA database for New York over the internet,</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># and unzip it into our local directory</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># This updates annually, which means that this post likely won&#39;t</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># generate the exact same results after 2022</span>
</span></span><span style="display:flex;"><span>httr<span style="color:#666">::</span><span style="color:#00f">GET</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#ba2121">&#34;https://apps.fs.usda.gov/fia/datamart/Databases/SQLite_FIADB_NY.zip&#34;</span>,
</span></span><span style="display:flex;"><span>  httr<span style="color:#666">::</span><span style="color:#00f">write_disk</span>(<span style="color:#ba2121">&#34;SQLite_FIADB_NY.zip&#34;</span>, <span style="color:#008000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">unzip</span>(<span style="color:#ba2121">&#34;SQLite_FIADB_NY.zip&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># We&#39;re going to work with the database through dplyr&#39;s database connections</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># But first, we need to create a DBI connection to the database and</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># load out tables:</span>
</span></span><span style="display:flex;"><span>con <span style="color:#666">&lt;-</span> DBI<span style="color:#666">::</span><span style="color:#00f">dbConnect</span>(RSQLite<span style="color:#666">::</span><span style="color:#00f">SQLite</span>(), dbname <span style="color:#666">=</span> <span style="color:#ba2121">&#34;FIADB_NY.db&#34;</span>)
</span></span><span style="display:flex;"><span>trees <span style="color:#666">&lt;-</span> <span style="color:#00f">tbl</span>(con, <span style="color:#ba2121">&#34;TREE&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plots <span style="color:#666">&lt;-</span> <span style="color:#00f">tbl</span>(con, <span style="color:#ba2121">&#34;PLOT&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># The FIA database has every measurement ever collected by the program;</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># we&#39;ll filter to only the most recent survey for each of the plots.</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Plots are measured on a rolling 7 year basis, so we&#39;ll also cut out any</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># plots which might not be remeasured anymore with a call to filter()</span>
</span></span><span style="display:flex;"><span>plots <span style="color:#666">&lt;-</span> plots <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">group_by</span>(PLOT) <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">filter</span>(INVYR <span style="color:#666">==</span> <span style="color:#00f">max</span>(INVYR, na.rm <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">TRUE</span>)) <span style="color:#666">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">ungroup</span>() <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">filter</span>(INVYR <span style="color:#666">&gt;</span> <span style="color:#666">2009</span>) <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">collect</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">copy_to</span>(con, plots, <span style="color:#ba2121">&#34;newest_plots&#34;</span>, <span style="color:#008000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>newest_plots <span style="color:#666">&lt;-</span> <span style="color:#00f">tbl</span>(con, <span style="color:#ba2121">&#34;newest_plots&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># Now we&#39;ll use a filtering join to select only trees measured in the most</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># recent sample at each plot</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># We&#39;ll also count how many trees were at each plot,</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># sum up their AGB, </span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic"># and save out a few other useful columns like latitude and longitude</span>
</span></span><span style="display:flex;"><span>plot_measurements <span style="color:#666">&lt;-</span> trees <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">right_join</span>(newest_plots, by <span style="color:#666">=</span> <span style="color:#00f">c</span>(<span style="color:#ba2121">&#34;INVYR&#34;</span>, <span style="color:#ba2121">&#34;PLOT&#34;</span>)) <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">group_by</span>(PLOT) <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">summarise</span>(
</span></span><span style="display:flex;"><span>    yr <span style="color:#666">=</span> <span style="color:#00f">mean</span>(INVYR, na.rm <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">TRUE</span>),
</span></span><span style="display:flex;"><span>    plot <span style="color:#666">=</span> <span style="color:#00f">mean</span>(PLOT, na.rm <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">TRUE</span>),
</span></span><span style="display:flex;"><span>    lat <span style="color:#666">=</span> <span style="color:#00f">mean</span>(LAT, na.rm <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">TRUE</span>),
</span></span><span style="display:flex;"><span>    long <span style="color:#666">=</span> <span style="color:#00f">mean</span>(LON, na.rm <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">TRUE</span>),
</span></span><span style="display:flex;"><span>    n_trees <span style="color:#666">=</span> <span style="color:#00f">n</span>(),
</span></span><span style="display:flex;"><span>    agb <span style="color:#666">=</span> <span style="color:#00f">sum</span>(DRYBIO_AG, na.rm <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>  ) <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">collect</span>() <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">mutate</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#408080;font-style:italic"># Because of how we joined, `n_trees` is always at least 1 -- </span>
</span></span><span style="display:flex;"><span>    <span style="color:#408080;font-style:italic"># even if there are 0 trees</span>
</span></span><span style="display:flex;"><span>    n_trees <span style="color:#666">=</span> <span style="color:#00f">ifelse</span>(<span style="color:#00f">is.na</span>(agb) <span style="color:#666">&amp;</span> n_trees <span style="color:#666">==</span> <span style="color:#666">1</span>, <span style="color:#666">0</span>, n_trees),
</span></span><span style="display:flex;"><span>    agb <span style="color:#666">=</span> <span style="color:#00f">ifelse</span>(<span style="color:#00f">is.na</span>(agb), <span style="color:#666">0</span>, agb)
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DBI<span style="color:#666">::</span><span style="color:#00f">dbDisconnect</span>(con)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>readr<span style="color:#666">::</span><span style="color:#00f">write_csv</span>(plot_measurements, <span style="color:#ba2121">&#34;plots.csv&#34;</span>)
</span></span></code></pre></div></details>
<p>With that pre-processing done, it&rsquo;s time to load our data and turn it into an sf object. We&rsquo;re going to reproject our data to use a coordinate reference system that the US government tends to use for national data products, like the FIA:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#00f">library</span>(sf)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">invisible</span>(<span style="color:#00f">sf_proj_network</span>(<span style="color:#008000;font-weight:bold">TRUE</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plot_measurements <span style="color:#666">&lt;-</span> 
</span></span><span style="display:flex;"><span>  readr<span style="color:#666">::</span><span style="color:#00f">read_csv</span>(<span style="color:#ba2121">&#34;https://www.tidymodels.org/learn/work/multi-scale/plots.csv&#34;</span>) <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">st_as_sf</span>(coords <span style="color:#666">=</span> <span style="color:#00f">c</span>(<span style="color:#ba2121">&#34;long&#34;</span>, <span style="color:#ba2121">&#34;lat&#34;</span>), crs <span style="color:#666">=</span> <span style="color:#666">4326</span>) <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">st_transform</span>(<span style="color:#666">5070</span>)
</span></span></code></pre></div><p>This is what we&rsquo;re going to resample. We want to assess our model&rsquo;s performance at multiple scales, following the approach in Riemann et al. That means we need to do the following:</p>
<ol>
<li>Block our study area using multiple sets of regular hexagons of different sizes, and assign our data to the hexagon it falls into within each set.</li>
<li>Perform leave-one-block-out cross-validation with each of those sets, fitting our model to <code>n - 1</code> of the <code>n</code> hexagons we&rsquo;ve created and assessing it on the hold-out hexagon.</li>
<li>Calculate model accuracy for each size based on the aggregated predictions for each of those held-out hexes.</li>
</ol>
<p>So to get started, we need to block our study area. We can do this using the <code>spatial_block_cv()</code> function from spatialsample. We&rsquo;ll generate ten different sets of hexagon tiles, using <code>cellsize</code> arguments of between 10,000 and 100,000 meters. The code to do that, and to store all of our resamples in a single tibble, looks like this:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#00f">set.seed</span>(<span style="color:#666">123</span>)
</span></span><span style="display:flex;"><span><span style="color:#00f">library</span>(dplyr)
</span></span><span style="display:flex;"><span><span style="color:#00f">library</span>(spatialsample)
</span></span><span style="display:flex;"><span>cellsize <span style="color:#666">&lt;-</span> <span style="color:#00f">seq</span>(<span style="color:#666">10</span>, <span style="color:#666">100</span>, <span style="color:#666">10</span>) <span style="color:#666">*</span> <span style="color:#666">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>create_resample <span style="color:#666">&lt;-</span> <span style="color:#00f">function</span>(cellsize) {
</span></span><span style="display:flex;"><span>  <span style="color:#00f">spatial_block_cv</span>(
</span></span><span style="display:flex;"><span>    plot_measurements,
</span></span><span style="display:flex;"><span>    v <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">Inf</span>,
</span></span><span style="display:flex;"><span>    cellsize <span style="color:#666">=</span> cellsize,
</span></span><span style="display:flex;"><span>    square <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">FALSE</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>riemann_resamples <span style="color:#666">&lt;-</span> <span style="color:#00f">tibble</span>(
</span></span><span style="display:flex;"><span>  cellsize <span style="color:#666">=</span> cellsize,
</span></span><span style="display:flex;"><span>  resamples <span style="color:#666">=</span> purrr<span style="color:#666">::</span><span style="color:#00f">map</span>(cellsize, create_resample)
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Two things to highlight about this code:</p>
<ul>
<li><code>cellsize</code> is in meters because our coordinate reference system is in meters. This argument represents the length of the <a href="https://en.wikipedia.org/wiki/Apothem">apothem</a>, from the center of each polygon to the middle of the side.</li>
<li><code>v</code> is <code>Inf</code> because we want to perform leave-one-block-out cross-validation, but we don&rsquo;t know how many blocks there will be before they&rsquo;re created. This is the supported way to do leave-one-X-out cross-validation in spatialsample &gt; 0.2.0 (another option is to set <code>v = NULL</code>).</li>
</ul>
<p>If we want, we can visualize a few of our resamples, to get a sense of what our tiling looks like:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#00f">autoplot</span>(riemann_resamples<span style="color:#666">$</span>resamples[[9]])
</span></span></code></pre></div><img src="figs/unnamed-chunk-4-1.svg" width="672" />
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#00f">autoplot</span>(riemann_resamples<span style="color:#666">$</span>resamples[[10]])
</span></span></code></pre></div><img src="figs/unnamed-chunk-5-1.svg" width="672" />
<p>And that&rsquo;s step 1 of the process completed! Now we need to move on to step 2, and actually fit models to each of these resamples. As a heads-up, this is a <em>lot</em> of models, and so is going to take a while:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>riemann_resamples<span style="color:#666">$</span>resamples <span style="color:#666">%&gt;%</span> purrr<span style="color:#666">::</span><span style="color:#00f">map_dbl</span>(nrow) <span style="color:#666">%&gt;%</span> <span style="color:#00f">sum</span>()
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#&gt; [1] 2600</span>
</span></span></code></pre></div><p>Linear regression was invented around 1805, long before the Analytical Engine was a twinkle in Babbage&rsquo;s eye. Whenever you get frustrated at how long it takes to fit many models, it&rsquo;s nice to take a step back and recognize that we&rsquo;re asking our poor, overworked computers to fit roughly as many models as were used in the first ~100 years of the technique&rsquo;s life.</p>
<p>Now let&rsquo;s load the rest of the tidymodels packages, then use them to define a workflow (from the workflows package), specifying the formula and model that we want to fit to each resample:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#00f">library</span>(tidymodels)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lm_workflow <span style="color:#666">&lt;-</span> <span style="color:#00f">workflow</span>(agb <span style="color:#666">~</span> n_trees, <span style="color:#00f">linear_reg</span>())
</span></span></code></pre></div><p>Next, we&rsquo;ll actually apply that workflow a few thousand times! Now as we said at the start, we aren&rsquo;t looking to tune our models using these resamples. Instead, we&rsquo;re looking to see how well our point predictions do at estimating AGB across larger areas. As such, we don&rsquo;t really care about calculating model metrics for each hexagon, and we&rsquo;ll set our code to only calculate a single metric (root-mean-squared error, or RMSE) to save a little bit of time. We&rsquo;ll also use the <code>control_resamples()</code> function with <code>save_pred = TRUE</code> to make sure we keep the predictions we&rsquo;re making across each resample. We can add these predictions as a new column to our resamples using the following:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>riemann_resamples <span style="color:#666">&lt;-</span> riemann_resamples <span style="color:#666">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">mutate</span>(
</span></span><span style="display:flex;"><span>    resampled_outputs <span style="color:#666">=</span> purrr<span style="color:#666">::</span><span style="color:#00f">map</span>(
</span></span><span style="display:flex;"><span>      resamples, 
</span></span><span style="display:flex;"><span>      fit_resamples,
</span></span><span style="display:flex;"><span>      object <span style="color:#666">=</span> lm_workflow,
</span></span><span style="display:flex;"><span>      metrics <span style="color:#666">=</span> <span style="color:#00f">metric_set</span>(rmse),
</span></span><span style="display:flex;"><span>      control <span style="color:#666">=</span> <span style="color:#00f">control_resamples</span>(save_pred <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>  )
</span></span></code></pre></div><p>The <code>riemann_resamples</code> object now includes both our original resamples as well as the predictions generated from each run of the model. We can use the following code to &ldquo;unnest&rdquo; our predictions and estimate both the average &ldquo;true&rdquo; AGB and our average prediction at each hexagon:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>riemann_metrics <span style="color:#666">&lt;-</span> riemann_resamples <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">select</span>(cellsize, resampled_outputs) <span style="color:#666">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">unnest</span>(resampled_outputs) <span style="color:#666">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">transmute</span>(
</span></span><span style="display:flex;"><span>    cellsize <span style="color:#666">=</span> cellsize,
</span></span><span style="display:flex;"><span>    mean_agb  <span style="color:#666">=</span> purrr<span style="color:#666">::</span><span style="color:#00f">map_dbl</span>(.predictions, <span style="color:#00f">function</span>(x) <span style="color:#00f">mean</span>(x<span style="color:#666">$</span>agb)),
</span></span><span style="display:flex;"><span>    mean_pred <span style="color:#666">=</span> purrr<span style="color:#666">::</span><span style="color:#00f">map_dbl</span>(.predictions, <span style="color:#00f">function</span>(x) <span style="color:#00f">mean</span>(x<span style="color:#666">$</span>.pred))
</span></span><span style="display:flex;"><span>  ) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">head</span>(riemann_metrics)
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#&gt; # A tibble: 6 × 3</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#&gt;   cellsize mean_agb mean_pred</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#&gt;      &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#&gt; 1    10000    5930.     7161.</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#&gt; 2    10000    6265.     7020.</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#&gt; 3    10000   11766.     7673.</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#&gt; 4    10000   28067.    21806.</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#&gt; 5    10000   13132.    17911.</span>
</span></span><span style="display:flex;"><span><span style="color:#408080;font-style:italic">#&gt; 6    10000       0      6287.</span>
</span></span></code></pre></div><p>Now that we&rsquo;ve got our &ldquo;true&rdquo; and estimated AGB for each hexagon, all that&rsquo;s left is for us to calculate our model accuracy metrics for each aggregation scale we investigated. We can use functions from yardstick to quickly calculate our root-mean-squared error (RMSE) and mean absolute error (MAE) for each cell size we investigated:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>riemann_metrics <span style="color:#666">&lt;-</span> riemann_metrics <span style="color:#666">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">group_by</span>(cellsize) <span style="color:#666">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">summarize</span>(rmse <span style="color:#666">=</span> <span style="color:#00f">rmse_vec</span>(mean_agb, mean_pred),
</span></span><span style="display:flex;"><span>            mae  <span style="color:#666">=</span>  <span style="color:#00f">mae_vec</span>(mean_agb, mean_pred))
</span></span></code></pre></div><p>And just like that, we&rsquo;ve got a multi-scale assessment of our model&rsquo;s accuracy! To repeat a point from earlier, we aren&rsquo;t using this as a way to tune our model. Instead, we can use our results to investigate and report how well our model does at different levels of aggregation. For instance, while it appears that both RMSE and MAE improve as we aggregate our predictions to larger and larger hexagons, some scales have a much larger difference between the two metrics than others. This hints that, at those specific scales, a few individual hexagons are large outliers driving RMSE higher, which might indicate that our model isn&rsquo;t performing well in a few specific locations:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#00f">library</span>(ggplot2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>riemann_metrics <span style="color:#666">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">pivot_longer</span>(<span style="color:#666">-</span>cellsize) <span style="color:#666">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">ggplot</span>(<span style="color:#00f">aes</span>(cellsize, value, color <span style="color:#666">=</span> name)) <span style="color:#666">+</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">geom_line</span>() <span style="color:#666">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00f">geom_point</span>() <span style="color:#666">+</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#00f">theme_minimal</span>()
</span></span></code></pre></div><img src="figs/unnamed-chunk-11-1.svg" width="672" />
<h2 id="references">References</h2>
<p>Riemann, R., Wilston, B. T., Lister, A., and Parks, S. 2010. An effective assessment protocol for continuous geospatial datasets of forest characteristics using USFS Forest Inventory and Analysis (FIA) data. Remote Sensing of Environment, 114, pp. 2337-2353. doi: 10.1016/j.rse.2010.05.010.</p>
<h2 id="session-information">Session information</h2>
<pre tabindex="0"><code>#&gt; ─ Session info ─────────────────────────────────────────────────────
#&gt;  setting  value
#&gt;  version  R version 4.2.1 (2022-06-23)
#&gt;  os       Ubuntu 20.04.4 LTS
#&gt;  system   x86_64, linux-gnu
#&gt;  ui       X11
#&gt;  language (EN)
#&gt;  collate  en_US.UTF-8
#&gt;  ctype    en_US.UTF-8
#&gt;  tz       America/New_York
#&gt;  date     2022-07-06
#&gt;  pandoc   2.17.1.1 @ /usr/lib/rstudio/bin/quarto/bin/ (via rmarkdown)
#&gt; 
#&gt; ─ Packages ─────────────────────────────────────────────────────────
#&gt;  package       * version date (UTC) lib source
#&gt;  broom         * 0.8.0   2022-04-13 [1] CRAN (R 4.2.0)
#&gt;  dials         * 1.0.0   2022-06-14 [1] CRAN (R 4.2.1)
#&gt;  dplyr         * 1.0.9   2022-04-28 [1] CRAN (R 4.2.0)
#&gt;  ggplot2       * 3.3.6   2022-05-03 [1] CRAN (R 4.2.0)
#&gt;  infer         * 1.0.2   2022-06-10 [1] CRAN (R 4.2.0)
#&gt;  parsnip       * 1.0.0   2022-06-16 [1] CRAN (R 4.2.1)
#&gt;  purrr         * 0.3.4   2020-04-17 [1] CRAN (R 4.2.0)
#&gt;  recipes       * 0.2.0   2022-02-18 [1] CRAN (R 4.2.0)
#&gt;  rlang           1.0.3   2022-06-27 [1] CRAN (R 4.2.1)
#&gt;  rsample       * 1.0.0   2022-06-24 [1] CRAN (R 4.2.1)
#&gt;  spatialsample * 0.2.0   2022-06-17 [1] CRAN (R 4.2.1)
#&gt;  tibble        * 3.1.7   2022-05-03 [1] CRAN (R 4.2.0)
#&gt;  tidymodels    * 0.2.0   2022-03-19 [1] CRAN (R 4.2.1)
#&gt;  tune          * 0.2.0   2022-03-19 [1] CRAN (R 4.2.1)
#&gt;  workflows     * 0.2.6   2022-03-18 [1] CRAN (R 4.2.1)
#&gt;  yardstick     * 1.0.0   2022-06-06 [1] CRAN (R 4.2.1)
#&gt; 
#&gt;  [1] /home/mikemahoney218/R/x86_64-pc-linux-gnu-library/4.2
#&gt;  [2] /usr/local/lib/R/site-library
#&gt;  [3] /usr/lib/R/site-library
#&gt;  [4] /usr/lib/R/library
#&gt; 
#&gt; ────────────────────────────────────────────────────────────────────
</code></pre>
      </div>


      <div class="article-footer">
      
      <div style="float:left">
      
        <div class='itemTitle' align="left" style='font-size:.8em; line-height:2em'>Previous</div>
        <a href="/learn/work/case-weights/">Creating case weights based on time</a>
      
      </div>
      
      
      <div style="float:right">
      
      </div>
     </div> 

      </div>

      <div class="column25">
        <div class="section hideOnMobile">
          <div class="sectionTitle">Contents</div>
          <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#multi-scale-assessment">Multi-scale Assessment</a></li>
    <li><a href="#references">References</a></li>
    <li><a href="#session-information">Session information</a></li>
  </ul>
</nav>
        </div>
      
        <div class="section">
          <div class="sectionTitle">Resources</div>
          




<div class="event">
  
  <div class="eventTitle">
    <a href="/find/"><i class="fas fa-search fa-xs"></i>&nbsp;&nbsp;Find</a>
  </div>
  <div class="eventDetails">Explore searchable tables of all tidymodels packages and functions.</div>
</div>






<div class="event">
  
  <div class="eventTitle">
    <a href="/books/"><i class="fas fa-book-open fa-xs"></i>&nbsp;&nbsp;Books</a>
  </div>
  <div class="eventDetails">Study up on statistics and modeling with our comprehensive books.</div>
</div>






<div class="event">
  
  <div class="eventTitle">
    <a href="https://www.tidyverse.org/tags/tidymodels/" target="_blank"><i class="fas fa-bullhorn fa-xs"></i>&nbsp;&nbsp;News</a>
  </div>
  <div class="eventDetails">Hear the latest about tidymodels packages at the <a href="https://www.tidyverse.org/tags/tidymodels/">tidyverse blog</a>.</div>
</div>



        </div>
      </div>
      


    </div>
  </div>  
</div> 


        <div id="rStudioFooter" class="band">
          <div class="bandContent">
            <div id="copyright">
              
              
              Proudly supported by <a class="rstudioLogo" href="https://www.rstudio.com/"></a>
              
            </div>
            <div id="logos">
              
              
            </div>
            
            <span class="float-right" aria-hidden="true">
              <a href="#" class="back-to-top">
                <span class="button_icon">
                  <i class="fas fa-chevron-up fa-2x"></i>
                </span>
              </a>
            </span>
            
          </div>
        </div>

      </div>  
    </div>  

    

    
<script src="/js/math-code.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
  }
});
</script>
<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-20375833-29', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

</body>
</html>
